google.maps.event.addDomListener(window,"load",function(){var t=new n,e=$("#info-window").html(),i=Handlebars.compile(e),o=$("#category-list").html(),a=Handlebars.compile(o),s=new Autolinker;function n(){this.map,this.mapOptions={zoom:Math.floor(settings.map_zoom),maxZoom:Math.floor(settings.max_zoom),center:new google.maps.LatLng(0,0),mapTypeId:google.maps.MapTypeId.ROADMAP,styles:"0"===settings.map_styles?"":jQuery.parseJSON(settings.map_styles),draggable:"0"===settings.mouse_drag,scrollwheel:"0"===settings.mouse_scroll,gestureHandling:"cooperative"},this.catIndexed={},this.infoWindow=new google.maps.InfoWindow,this.filter=[]}jQuery(document).ready(function(e){t.initMap()}),n.prototype.initMap=function(){this.indexCatData(),this.initClickEvents(),settings.center_lat&&settings.center_lng&&(this.mapOptions.center=new google.maps.LatLng(settings.center_lat,settings.center_lng)),this.map=new google.maps.Map(document.getElementById("map-canvas"),this.mapOptions),google.maps.event.addDomListener(window,"resize",function(){var e=t.map.getCenter();google.maps.event.trigger(t.map,"resize"),t.map.setCenter(e)}),settings.filter_load?this.filterLoad():this.placeMarkers(settings.fit_bounds),this.setupPOILists()},n.prototype.checkIsMatch=function(t){return!this.filter||"object"==typeof this.filter&&(!this.filter.length||-1!==this.filter.indexOf(poi[t].cat_id)||"1"==this.catIndexed[poi[t].cat_id].filter_resist)||("string"==typeof this.filter||"number"==typeof this.filter)&&poi[t].id==this.filter},n.prototype.createMarker=function(e,i){if(Number(poi[e].lat)&&Number(poi[e].lng)){var o=this.catIndexed[poi[e].cat_id],a=this.categoryOptionCheck(["filter_resist"]),s=new google.maps.LatLng(poi[e].lat,poi[e].lng);if("1"!=settings.poi_num||a.indexOf(poi[e].cat_id)>-1){var n={position:s,map:this.map,title:poi[e].name};o&&(n.icon={url:""!==o.icon?o.icon:settings.poi_icon,anchor:new google.maps.Point(5,33)}),a.indexOf(poi[e].cat_id)>-1&&$.extend(n,{zIndex:8675309}),poi[e].marker=new google.maps.Marker(n)}else poi[e].marker=new MarkerWithLabel({position:s,draggable:!1,map:this.map,icon:settings.poi_icon,labelContent:poi[e].num,labelAnchor:new google.maps.Point(12,0),labelClass:"gj-maps-marker-label",labelStyle:{width:"25px",height:"25px",paddingTop:"4px",color:"white",background:o.color,"border-radius":"50%"}});google.maps.event.addListener(poi[e].marker,"click",(r=e,function(){var e=new google.maps.LatLng(poi[r].lat,poi[r].lng);t.map.panTo(e),t.showPOIInfo(poi[r])})),i.extend(s)}var r;return i},n.prototype.placeMarkers=function(t){for(var e=new google.maps.LatLngBounds,i=0,o=poi.length;i<o;i++){var a=this.checkIsMatch(i);void 0!==poi[i].marker?a?(poi[i].marker.setMap(this.map),e.extend(poi[i].marker.getPosition())):poi[i].marker.setMap(null):a&&(e=this.createMarker(i,e))}var s=this.map.getBounds();("1"==t||s&&!s.intersects(e))&&"((1, 180), (-1, -180))"!=e.toString()&&this.map.fitBounds(e)},n.prototype.indexCatData=function(){for(var t=0,e=cat.length;t<e;t++)this.catIndexed[cat[t].id]=cat[t]},n.prototype.setupPOILists=function(){for(var e="",i=0;i<cat.length;i++)"1"!=cat[i].hide_list&&(e+=this.markupCategoryList(cat[i]));$(".gjmaps-categories").append(e),$(".gjmaps-category div[data-type='label']").click(function(){t.showCategoryByEl($(this))}),0==settings.filter_load&&this.showCategoryByEl($(".gjmaps-category[data-cat-id='all']")),this.gjmapsEvents("gjmapsCatLoad",{loaded:!0}),this.resizeCategories()},n.prototype.resizeCategories=function(){var t,e=$(".gjmaps-category");t=$(window).innerWidth()>768?e.length>2?(100-2*e.length)/e.length+"%":"50%":"100%",e.css("width",t)},n.prototype.getCatStyle=function(t){var e;return t.background="",t.text=!0,t.background_true=!1,"background"===settings.label_color?(t.icon?(e=t.icon.replace(/\/marker-/,"/symbol-"),t.background="background-image: url("+e+");"):t.background="",t.background_true=!0,t.color_style="border: solid 1px "+t.color+";background-color: "+t.color+";"):"text"===settings.label_color?(t.background="",t.color_style="color: "+t.color+";"):"icon"===settings.label_color&&(e=t.icon.replace(/\/marker-/,"/symbol-"),t.background="background-image: url("+e+");",t.text=!1),t},n.prototype.markupCategoryList=function(t){if(t.poi_list=settings.poi_list,t.poi_array=[],t=this.getCatStyle(t),1==settings.poi_list)for(var e=0,i=poi.length;e<i;e++)poi[e].cat_id===t.id&&(poi[e].show_num="1"==settings.poi_num,t.poi_array.push(poi[e]));return a(t)},n.prototype.showPOIInfo=function(t){if(t.phone&&(t.phone_link="1"===settings.phone_link&&t.phone.replace(/[\.\(\)\-\s]/g,"")),t.url){var e=s.parse(t.url),o=t.url.replace(/^https?:\/\/|\/$/g,"");e.length&&(t.url=e[0].getAnchorHref(),o=e[0].getAnchorText()),t.linkName=settings.link_text?settings.link_text:o}var a=i(t);this.infoWindow.setContent(a),this.infoWindow.open(this.map,t.marker);var n=$("body"),r=$("#map-canvas").offset().top-n.position().top;$(document.body).scrollTop()>r&&$(document.body).animate({scrollTop:r},300),this.gjmapsEvents("gjmapsPOIInfo",{id:t.id,cat_id:t.cat_id})},n.prototype.showCategoryByEl=function(t){var e=t.closest(".gjmaps-category"),i=e.attr("data-cat-id");"all"===i?(this.filter=[],$("[data-cat-id='all']").addClass("active"),e.siblings(".gjmaps-category").removeClass("active"),1==settings.poi_list&&$(".gjmaps-category ul").slideDown()):($("[data-cat-id='all']").removeClass("active"),e.siblings(".gjmaps-category").removeClass("active"),$(".gjmaps-category[data-cat-id="+i+"]").addClass("active"),1==settings.poi_list&&(e.siblings(".gjmaps-category").find("ul").slideUp(),$("ul",e).slideDown(),$(".gjmaps-category[data-cat-id="+i+"]").slideDown()),this.filter=[i]),this.gjmapsEvents("gjmapsCatClick",{category:i}),this.infoWindow.close(),this.placeMarkers(settings.fit_bounds),"all"!==i||settings.fit_bounds||(this.map.panTo(this.mapOptions.center),this.map.setZoom(this.mapOptions.zoom))},n.prototype.showCategoryByArr=function(t){this.filter=t,this.infoWindow.close(),this.placeMarkers(settings.fit_bounds)},n.prototype.filterLoad=function(){this.filter=[];for(var t=0;t<cat.length;t++)null!=cat[t].filter_resist&&this.filter.push(cat[t].id);this.placeMarkers()},n.prototype.categoryOptionCheck=function(t){for(var e=[],i=0;i<cat.length;i++)for(var o=0;o<t.length;o++)1==cat[i][t[o]]&&e.push(cat[i].id);return e},n.prototype.gjmapsEvents=function(t,e){$.event.trigger({type:t,gjmaps:e})},n.prototype.initClickEvents=function(){$("div.gjmaps-wrapper").on("click","li.poi",function(){for(var e=$(this).data("poi-id"),i=!1,o=0;poi.length>o;o++)if(poi[o].id==e){i=poi[o];break}0!=i&&t.showPOIInfo(i)}),$(document).on("click",".gjmaps-parent",function(){var e=$(this).data("cat-ids").split(",");t.showCategoryByArr(e)})}});
